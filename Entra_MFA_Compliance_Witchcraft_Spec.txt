â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
WITCHCRAFT PROMPT SPECIFICATION
MS 365 Entra ID - User Status & MFA Drift Compliance Tool
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PROJECT NAME: Entra MFA Compliance Guardian
TARGET AUDIENCE: Small business IT technicians (managing <50 users)
SKILL LEVEL: Novice (requires extensive inline comments)
FRAMEWORK COMPLIANCE: SOC 2, ISO 27001, NIST

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”® WITCH - PROMPT CONSTRUCTION
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ W - WHY (Problem & Purpose) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ PROBLEM STATEMENT:
â”‚ Small businesses need automated compliance monitoring for MS 365 Entra ID to
â”‚ meet SOC 2, ISO 27001, and NIST requirements. Manual audits are error-prone
â”‚ and time-consuming for teams managing multiple small business clients.
â”‚
â”‚ BUSINESS VALUE:
â”‚ - Detect MFA configuration drift before audit failures
â”‚ - Identify stale/inactive accounts for deprovisioning
â”‚ - Flag suspicious login patterns (15+ failed attempts)
â”‚ - Maintain weekly compliance audit trail
â”‚ - Enable security automation to remediate findings
â”‚
â”‚ COMPLIANCE REQUIREMENTS:
â”‚ - SOC 2 CC6.1: Logical access controls including MFA
â”‚ - ISO 27001 A.9.4.2: Secure log-on procedures
â”‚ - NIST 800-53 IA-2(1): Multi-factor authentication
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ I - INFRASTRUCTURE (Tech Stack) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ PLATFORM: Microsoft 365 Entra ID (Azure AD P2 license)
â”‚
â”‚ API & MODULES:
â”‚ - Microsoft Graph API (modern approach - no E5 required)
â”‚ - Required PowerShell modules:
â”‚   * Microsoft.Graph.Authentication
â”‚   * Microsoft.Graph.Users
â”‚   * Microsoft.Graph.Identity.SignIns
â”‚   * Microsoft.Graph.Reports
â”‚
â”‚ AUTHENTICATION:
â”‚ - App Registration with Client Secret (preferred for scheduled tasks)
â”‚ - Alternative: Certificate-based authentication (document both)
â”‚ - Required API Permissions:
â”‚   * User.Read.All
â”‚   * UserAuthenticationMethod.Read.All
â”‚   * AuditLog.Read.All
â”‚   * Directory.Read.All
â”‚
â”‚ DEPENDENCIES:
â”‚ - PowerShell 7.x (cross-platform support)
â”‚ - .NET Framework 4.7.2+ or .NET Core 3.1+
â”‚ - SMTP access for email notifications (port 587/TLS or 465/SSL)
â”‚
â”‚ ENVIRONMENT:
â”‚ - Windows 10/11 or Windows Server 2019+
â”‚ - Local file system access for baseline storage
â”‚ - Internet connectivity to graph.microsoft.com
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ T - TASKS (Detailed Requirements) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ PRIMARY TASKS:
â”‚
â”‚ 1. AUTHENTICATION & SETUP
â”‚    - Accept tenant ID, client ID, and client secret as parameters
â”‚    - Connect to Microsoft Graph API with proper scopes
â”‚    - Validate connection before proceeding
â”‚    - Handle token refresh automatically
â”‚
â”‚ 2. USER DATA COLLECTION
â”‚    Pull the following fields for ALL users (excluding guests):
â”‚    - userPrincipalName
â”‚    - displayName
â”‚    - accountEnabled (true/false)
â”‚    - department
â”‚    - createdDateTime
â”‚    - signInActivity.lastSignInDateTime
â”‚    - signInActivity.lastSuccessfulSignInDateTime
â”‚    - assignedLicenses (list of SKUs)
â”‚
â”‚ 3. MFA AUTHENTICATION METHODS RETRIEVAL
â”‚    For each user, collect:
â”‚    - All registered authentication methods (app, phone, SMS, email, FIDO2)
â”‚    - Default authentication method
â”‚    - Count of total methods registered
â”‚    - Method registration dates (if available)
â”‚
â”‚ 4. USER STATUS CLASSIFICATION
â”‚    Categorize each user based on sign-in activity:
â”‚
â”‚    ACTIVE:
â”‚    - Last successful sign-in within 20 days
â”‚    - Account enabled = true
â”‚    - At least 1 successful login in window
â”‚
â”‚    INACTIVE (STALE):
â”‚    - No successful sign-in for 21+ days
â”‚    - Account may be enabled or disabled
â”‚    - Flag for potential deprovisioning
â”‚
â”‚    WARNING:
â”‚    - 15+ failed login attempts in last 20 days
â”‚    - Flag for security review (potential compromise)
â”‚
â”‚    DISABLED:
â”‚    - accountEnabled = false
â”‚
â”‚ 5. MFA DRIFT DETECTION
â”‚    Compare current state against baseline (previous week's snapshot):
â”‚
â”‚    FIRST RUN BEHAVIOR:
â”‚    - If no baseline exists, create initial baseline file
â”‚    - Set expectations: Default method = authenticator app
â”‚    - Set expectations: Minimum 2 methods registered
â”‚    - Flag all non-compliant users in initial report
â”‚
â”‚    SUBSEQUENT RUNS:
â”‚    - Load previous baseline JSON from local folder
â”‚    - Detect changes:
â”‚      * Default method changed from authenticator app
â”‚      * Number of methods decreased below 2
â”‚      * Any method added or removed
â”‚      * MFA completely disabled on previously compliant account
â”‚    - Classify drift severity:
â”‚      * CRITICAL: MFA disabled or removed entirely
â”‚      * HIGH: Default method changed or methods dropped below 2
â”‚      * MEDIUM: Non-authenticator method added
â”‚      * LOW: Additional method added (improvement)
â”‚
â”‚ 6. REPORTING & OUTPUT
â”‚    Generate CSV report with columns:
â”‚    - UserPrincipalName
â”‚    - DisplayName
â”‚    - Department
â”‚    - Status (Active/Inactive/Warning/Disabled)
â”‚    - AccountEnabled
â”‚    - CreatedDateTime
â”‚    - LastSignInDateTime
â”‚    - LastSuccessfulSignInDateTime
â”‚    - DaysSinceLastSignIn (calculated)
â”‚    - FailedLoginCount (last 20 days)
â”‚    - LicensesSKUs (comma-separated)
â”‚    - MFA_DefaultMethod
â”‚    - MFA_MethodCount
â”‚    - MFA_Methods (comma-separated list)
â”‚    - MFA_DriftStatus (None/Low/Medium/High/Critical)
â”‚    - MFA_DriftDetails (description of what changed)
â”‚    - ComplianceFlags (comma-separated: NoMFA, StaleAccount, SuspiciousLogins)
â”‚
â”‚    Include summary section at top of CSV:
â”‚    - Report Date
â”‚    - Total Users Scanned
â”‚    - Active Users
â”‚    - Inactive Users
â”‚    - Warning Users
â”‚    - Users with MFA Drift
â”‚    - Critical Findings Count
â”‚
â”‚ 7. BASELINE MANAGEMENT
â”‚    - Save current state as JSON in ./baselines/ folder
â”‚    - Filename format: EntraMFA_Baseline_YYYY-MM-DD.json
â”‚    - Retain last 8 weeks of baselines (auto-cleanup old files)
â”‚    - Include metadata: scan date, user count, script version
â”‚
â”‚ 8. EMAIL NOTIFICATION
â”‚    Send email to: services@bansheecybersecurity.com
â”‚    - Subject: "Entra MFA Compliance Report - [TenantName] - [Date]"
â”‚    - Body includes:
â”‚      * Executive summary (counts of each status)
â”‚      * Critical findings highlighted
â”‚      * Link/path to full CSV report
â”‚    - Attach CSV report to email
â”‚    - Only send if drift detected OR critical findings exist
â”‚    - Option to force send weekly regardless of findings
â”‚
â”‚ 9. ERROR HANDLING & LOGGING
â”‚    - Create log file in ./logs/ folder
â”‚    - Log filename: EntraCompliance_YYYY-MM-DD_HHMMSS.log
â”‚    - Log all API calls, errors, and warnings
â”‚    - Handle common errors:
â”‚      * Invalid credentials
â”‚      * Insufficient API permissions
â”‚      * Network/timeout issues
â”‚      * Missing baseline file (first run)
â”‚    - Provide clear error messages for novice users
â”‚
â”‚ 10. CONFIGURATION FILE
â”‚     Create config.json for easy customization:
â”‚     - Tenant ID
â”‚     - Client ID
â”‚     - Client Secret (encrypted or reference to Key Vault)
â”‚     - Email settings (SMTP server, port, credentials)
â”‚     - Thresholds (days for inactive, failed login count)
â”‚     - Baseline retention period
â”‚     - Report recipients
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ C - CHARACTER (User & Audience) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ PRIMARY USER: Compliance Analyst
â”‚ - Responsible for SOC 2, ISO 27001, NIST compliance
â”‚ - Needs weekly audit trail for identity access controls
â”‚ - Must identify MFA drift and stale accounts
â”‚ - Will use reports to drive remediation actions
â”‚
â”‚ SECONDARY USER: Small Business IT Technicians
â”‚ - Managing <50 users per client
â”‚ - May support multiple client tenants
â”‚ - Novice PowerShell skill level
â”‚ - Need clear instructions and inline comments
â”‚ - Will run as weekly scheduled task
â”‚
â”‚ SKILL LEVEL REQUIREMENTS:
â”‚ - Extensive inline comments explaining each section
â”‚ - Step-by-step setup guide (separate README.md)
â”‚ - Clear parameter descriptions
â”‚ - Example configuration file with comments
â”‚ - Troubleshooting section for common errors
â”‚
â”‚ USE CASE SCENARIOS:
â”‚ 1. Initial deployment: First-time setup and baseline creation
â”‚ 2. Weekly execution: Automated drift detection
â”‚ 3. Audit preparation: Generate compliance evidence
â”‚ 4. Incident response: Identify compromised accounts
â”‚ 5. Multi-tenant: Run against multiple small business clients
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ H - HARNESS/HANDOFF (Execution & Scheduling) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ EXECUTION METHOD:
â”‚ - PowerShell script (.ps1) designed for Windows Task Scheduler
â”‚ - Support manual execution with -WhatIf for testing
â”‚ - Support -Force parameter to skip confirmations
â”‚
â”‚ SCHEDULING:
â”‚ - Weekly execution (recommended: Monday 6 AM)
â”‚ - Windows Task Scheduler configuration provided
â”‚ - Alternative: Azure Automation Runbook (document as option)
â”‚
â”‚ FOLDER STRUCTURE:
â”‚ ./EntraMFACompliance/
â”‚   â”œâ”€â”€ Invoke-EntraMFACompliance.ps1    (main script)
â”‚   â”œâ”€â”€ config.json                       (configuration)
â”‚   â”œâ”€â”€ README.md                         (setup guide)
â”‚   â”œâ”€â”€ /baselines/                       (JSON snapshots)
â”‚   â”œâ”€â”€ /reports/                         (CSV outputs)
â”‚   â””â”€â”€ /logs/                            (execution logs)
â”‚
â”‚ SCHEDULED TASK PARAMETERS:
â”‚ - Run whether user is logged on or not
â”‚ - Run with highest privileges
â”‚ - Trigger: Weekly on Monday at 6:00 AM
â”‚ - Action: powershell.exe -ExecutionPolicy Bypass -File "path\to\script.ps1"
â”‚
â”‚ STORAGE LOCATIONS:
â”‚ - Baselines: Local folder ./baselines/ (JSON format)
â”‚ - Reports: Local folder ./reports/ (CSV format)
â”‚ - Logs: Local folder ./logs/ (TXT format)
â”‚ - Retention: Auto-delete files older than 60 days
â”‚
â”‚ EMAIL DELIVERY:
â”‚ - Automatic send after successful report generation
â”‚ - Recipient: services@bansheecybersecurity.com
â”‚ - Timing: Immediately after CSV creation
â”‚ - Fallback: Save email as .eml file if SMTP fails
â”‚
â”‚ MAINTENANCE:
â”‚ - Self-cleaning: Remove baselines/reports/logs >60 days old
â”‚ - Health check: Verify Graph API connectivity before scan
â”‚ - Update check: Notify if newer version available (optional)
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
âœ¨ CRAFT - VALIDATION CRITERIA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ C - CODE COMPLETENESS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ VERIFICATION CHECKLIST:
â”‚ â˜ All 10 tasks from WITCH section implemented
â”‚ â˜ User data collection includes all 8 required fields
â”‚ â˜ MFA methods collection covers all authentication types
â”‚ â˜ User status logic correctly implements Active/Inactive/Warning/Disabled
â”‚ â˜ Drift detection handles first run and subsequent comparisons
â”‚ â˜ CSV report contains all 18 required columns
â”‚ â˜ Summary section included at top of CSV
â”‚ â˜ Baseline save/load functionality complete
â”‚ â˜ Email notification with attachment works
â”‚ â˜ Configuration file supports all settings
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ R - RISKS & ASSUMPTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ RISKS TO VALIDATE:
â”‚ â˜ Client secret stored securely (not hardcoded in script)
â”‚ â˜ API permissions documented and validated
â”‚ â˜ Rate limiting handled for tenants with 1000+ users
â”‚ â˜ Graph API throttling errors caught and retried
â”‚ â˜ Failed login count may be unavailable in P2 (requires P1/E5 for full logs)
â”‚ â˜ SignInActivity requires Azure AD Premium license
â”‚ â˜ SMTP credentials not stored in plain text
â”‚ â˜ Email delivery failures logged and reported
â”‚ â˜ Baseline file corruption handling
â”‚ â˜ Concurrent execution prevention (lock file)
â”‚
â”‚ ASSUMPTIONS TO CHALLENGE:
â”‚ â˜ Assumes P2 license provides access to signInActivity
â”‚ â˜ Assumes local disk space sufficient for 60 days retention
â”‚ â˜ Assumes SMTP relay available (may need auth or allow list)
â”‚ â˜ Assumes single tenant execution (multi-tenant support needed?)
â”‚ â˜ Assumes Windows environment (cross-platform consideration?)
â”‚ â˜ Assumes app registration permissions already granted by admin
â”‚ â˜ Assumes CSV format sufficient (Excel .xlsx alternative needed?)
â”‚ â˜ Assumes 50 users = safe API call volume (batch processing needed?)
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ A - ADDED EXTRAS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ HELPFUL ADDITIONS:
â”‚ â˜ README.md with Azure app registration walkthrough
â”‚ â˜ Sample config.json with explanatory comments
â”‚ â˜ Task Scheduler XML export for easy import
â”‚ â˜ Test mode (-WhatIf) to preview without saving
â”‚ â˜ Verbose logging option for troubleshooting
â”‚ â˜ HTML report option in addition to CSV
â”‚ â˜ Dashboard summary (compliance score calculation)
â”‚ â˜ Remediation script templates for common findings
â”‚
â”‚ PROBLEMATIC ADDITIONS TO AVOID:
â”‚ â˜ Automatic user disabling (requires approval workflow)
â”‚ â˜ Automatic MFA enrollment (user interaction required)
â”‚ â˜ Sending reports to end users (privacy concern)
â”‚ â˜ Storing credentials in script file
â”‚ â˜ External dependencies not in standard modules
â”‚ â˜ Cloud storage without encryption
â”‚ â˜ Telemetry/phone-home without disclosure
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ F - FLEXIBILITY & SCALING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ MODULARITY REQUIREMENTS:
â”‚ â˜ Separate functions for each major task (connect, collect, analyze, report)
â”‚ â˜ Configuration externalized to config.json
â”‚ â˜ Thresholds parameterized (not hardcoded)
â”‚ â˜ Email templates separate from logic
â”‚ â˜ Graph API queries reusable across functions
â”‚
â”‚ MAINTAINABILITY:
â”‚ â˜ Inline comments for novice users (every 5-10 lines)
â”‚ â˜ Function headers with description, parameters, returns
â”‚ â˜ Consistent naming convention (Verb-Noun)
â”‚ â˜ Error messages reference line numbers or function names
â”‚ â˜ Version number in script header and config
â”‚
â”‚ SCALABILITY CONSIDERATIONS:
â”‚ â˜ Handle tenants up to 500 users (future growth)
â”‚ â˜ Batch Graph API calls for tenants >100 users
â”‚ â˜ Pagination support for large result sets
â”‚ â˜ Parallel processing option for multi-tenant scenarios
â”‚ â˜ Database backend option (vs file-based) for enterprise use
â”‚ â˜ Configurable batch size for API calls
â”‚
â”‚ EXTENSIBILITY:
â”‚ â˜ Plugin architecture for custom compliance rules
â”‚ â˜ Export/import baseline format documented
â”‚ â˜ Webhook support for integration with SIEM/SOAR
â”‚ â˜ Additional authentication methods easy to add
â”‚ â˜ Custom report columns via config file
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€ T - TESTING, LOGGING & OUTPUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â”‚
â”‚ INPUT VALIDATION:
â”‚ â˜ Verify config.json exists before execution
â”‚ â˜ Validate tenant ID format (GUID)
â”‚ â˜ Validate client ID format (GUID)
â”‚ â˜ Test client secret not empty
â”‚ â˜ Verify output folders exist (create if missing)
â”‚ â˜ Check PowerShell version >=7.0
â”‚ â˜ Validate required modules installed
â”‚ â˜ Test Graph API connectivity before full scan
â”‚
â”‚ LOGGING REQUIREMENTS:
â”‚ â˜ Timestamp every log entry
â”‚ â˜ Log levels: INFO, WARNING, ERROR, DEBUG
â”‚ â˜ Log API calls with response times
â”‚ â˜ Log drift detection results
â”‚ â˜ Log email send success/failure
â”‚ â˜ Log file rotation (new file daily or per run)
â”‚ â˜ Include correlation ID for troubleshooting
â”‚
â”‚ ERROR HANDLING:
â”‚ â˜ Try/Catch blocks around all API calls
â”‚ â˜ Graceful degradation if optional data unavailable
â”‚ â˜ Retry logic for transient Graph API errors
â”‚ â˜ Clear error messages for authentication failures
â”‚ â˜ Fallback behavior if baseline missing (first run)
â”‚ â˜ Continue processing other users if one fails
â”‚ â˜ Summary of errors at end of execution
â”‚
â”‚ OUTPUT VALIDATION:
â”‚ â˜ CSV file created successfully
â”‚ â˜ All expected columns present
â”‚ â˜ No truncated data (handle long strings)
â”‚ â˜ Proper CSV escaping (commas, quotes)
â”‚ â˜ Baseline JSON well-formed and parsable
â”‚ â˜ Email sent and delivery confirmed
â”‚ â˜ Attachment size within SMTP limits (<10MB)
â”‚
â”‚ TESTING SCENARIOS:
â”‚ â˜ First run (no baseline exists)
â”‚ â˜ Subsequent run (baseline exists, no changes)
â”‚ â˜ Drift detected (MFA method changed)
â”‚ â˜ New user added since last scan
â”‚ â˜ User deleted since last scan
â”‚ â˜ Invalid credentials
â”‚ â˜ Network timeout
â”‚ â˜ Empty tenant (0 users)
â”‚ â˜ Large tenant (500+ users)
â”‚ â˜ Guest users present (should be excluded)
â”‚ â˜ Users without MFA registered
â”‚ â˜ Users with multiple MFA methods
â”‚ â˜ Email delivery failure
â”‚ â˜ Disk space full
â”‚ â˜ Baseline file corrupted
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“‹ DELIVERABLES CHECKLIST
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SCRIPTS:
â˜ Invoke-EntraMFACompliance.ps1 (main script with extensive comments)

DOCUMENTATION:
â˜ README.md (setup guide for novice users)
â˜ SETUP_GUIDE.md (Azure app registration walkthrough)
â˜ TROUBLESHOOTING.md (common errors and solutions)

CONFIGURATION:
â˜ config.json (template with explanatory comments)
â˜ config.EXAMPLE.json (safe to commit to git)
â˜ TaskScheduler_EntraCompliance.xml (import-ready task)

SUPPORTING FILES:
â˜ .gitignore (exclude secrets, logs, reports)
â˜ LICENSE (if open source)
â˜ CHANGELOG.md (version history)

TESTING:
â˜ Test-GraphConnection.ps1 (validate API permissions)
â˜ New-TestBaseline.ps1 (create sample baseline for testing)

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ¯ SUCCESS CRITERIA
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

The solution is successful when:

1. âœ… A novice IT technician can set up and run the script in <30 minutes
2. âœ… First run creates valid baseline without errors
3. âœ… Weekly runs detect MFA drift accurately
4. âœ… CSV report includes all required fields and summary
5. âœ… Email notifications arrive reliably at services@bansheecybersecurity.com
6. âœ… Stale accounts (21+ days) correctly flagged
7. âœ… Warning status triggers on 15+ failed logins
8. âœ… Script runs unattended via Task Scheduler
9. âœ… Inline comments make code understandable to novices
10. âœ… Compliance requirements (SOC 2, ISO 27001, NIST) supported

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ NOTES & SPECIAL CONSIDERATIONS
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

1. GRAPH API LIMITATIONS WITH P2 LICENSE:
   - signInActivity requires Azure AD Premium (P1/P2) âœ“ Available
   - Failed login counts require Azure AD audit logs (may need P1/E5)
   - If failed login data unavailable, document limitation and set to "N/A"

2. FIRST RUN TESTING SETUP:
   - Create sample baseline JSON for testing drift detection
   - Document process to manually modify baseline for validation
   - Include test cases: method removal, default change, user addition

3. MULTI-TENANT SUPPORT (FUTURE):
   - Current design: single tenant per execution
   - Future enhancement: loop through array of tenant configs
   - Each tenant gets separate baseline and report

4. SECURITY BEST PRACTICES:
   - Never commit config.json with real secrets to version control
   - Document Azure Key Vault integration option
   - Recommend certificate auth over client secret for production
   - Use Managed Identity if running in Azure Automation

5. COMPLIANCE AUDIT TRAIL:
   - Retain baselines for 60 days minimum (configurable)
   - CSV reports serve as evidence for auditors
   - Timestamp and version all outputs
   - Log who initiated manual runs (if applicable)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
END OF WITCHCRAFT SPECIFICATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Specification Version: 1.0
Created: 2025-10-07
Framework: WITCHCRAFT (WITCH + CRAFT)
Target Completion: [To be determined]
